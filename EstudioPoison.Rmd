---
title: "Estudio sobre infectados de coronavirus"
author: "Ricardo Alberich, Juan Gabriel Gomila y Arnau Mir"
date: ''
output: 
  ioslides_presentation:
    widescreen: true
    css: Mery_style.css
    fig_caption: yes
---
<script src="https://kit.fontawesome.com/a0edb659c7.js" crossorigin="anonymous"></script>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
reticulate::use_python("/Users/juangabriel/anaconda3/bin/python")
#reticulate::py_install("sympy")
```


# Planteamiento y modelado del problema

## Introducción

En estos días está como noticia estrella la pandemía por **coronavirus** que estamos sufriendo prácticamente todos los humanos que habitan nuestro planeta.

Una de las preguntas que nos podemos hacer es si la **pandemía** se **expande** igual por todo el mundo, o, por el contrario, hay lugares donde la **expansión** es distinta de los demás.


Seguidamente vamos a modelar el problema.

## Modelado del problema

En primer lugar, fijamos una fecha determinada donde el **coronavirus** ya se ha expandido.

Para dicha fecha, sea $n$ el número de personas que han estado expuestas al **coronavirus** dicho día.

Sea $p$ la probabilidad que una persona cualquiera se infecte. Si la infección no depende del lugar, podemos decir que el valor de $p$ será constante para todos los habitantes y lugares del mundo.

Por último, sea $X$ la variable aleatoria que nos da el número de infectados este día determinado. La distribución de $X$, suponiendo que la infección se realiza de forma aleatoria será **binomial** de parámetros $n$ y $p$: $X=B(n,p)$. 

## Modelado del problema
Como $n$ será muy grande, vamos a aproximar $X$ por una variable de Poisson de parámetro $\lambda = n\cdot p$.

Por tanto, modelaremos el número de infectados por una variable de Poisson de un cierto parámetro $\lambda$.

El valor de $\lambda$ es el valor medio de $X$, ($E(X)=\lambda$) o, dicho en otras palabras, es el número medio de infectados. Por dicho motivo, podemos estimar $\lambda$ usando la expresión siguiente:
$$
\begin{array}{rl}
\hat{\lambda} & =n\cdot \hat{p} = n\cdot \frac{\mbox{Número total de infectados}}{\mbox{número total de personas a infectar}}\\ & =\mbox{Número total de infectados}.
\end{array}
$$

## Modelado del problema

Sean ahora $P_1,\ldots,P_N$ los países involucrados en nuestro estudio, es decir, los países en los que el **coronavirus** se ha expandido en la fecha que hemos fijado.

Seguidamente, sea $X_i$ la variable aleatoria que nos da el número de infectados en el pais $P_i$ donde, si suponemos que todos los países se infectan de la misma manera, la distribución de $X_i$ será de Poisson de parámetro $\lambda_i$. 

El parámetro $\lambda_i$ será el número medio de infectados en el pais $P_i$. Por tanto, $\lambda_i =E(X_i)=n_i\cdot p$, donde $n_i$ es el número total de habitantes del pais $P_i$ y su estimación será $\hat{\lambda}_i =\mbox{número de infectados del país }P_i =k_i,$ a la que llamaremos $k_i$.

## Modelado del problema
La relación entre los parámetros $\hat{\lambda}_i$, número medio de infectados del país $P_i$ y $\hat{\lambda}$, número medio de infectados global, suponiendo que la infección se expande igual en todos los paises, es la siguiente:
$$
\hat{\lambda}_i =k_i \approx \frac{n_i}{n}\cdot \hat{\lambda}.
$$

Nuestro objetivo será, pues, ver si los valores de $\hat{\lambda}_i =k_i$ y los valores de $\frac{n_i}{n}\cdot \hat{\lambda}$ están suficientemente próximos.

Para ello, vamos a usar el test $\chi^2$ o el test de **bondad de ajuste**.

## Test $\chi^2$

Tendremos por tanto una tabla como la detallada a continuación:

<div class="center">
|Pais| Infectados reales | Infectados estimados |
|:---|:---:|:---:|
|$P_1$| $k_1$ | $\frac{n_1}{n}\cdot \hat{\lambda}$|
|$P_2$| $k_2$ | $\frac{n_2}{n}\cdot \hat{\lambda}$|
|$\vdots$|$\vdots$ | $\vdots$|
|$P_N$ | $k_N$ | $\frac{n_N}{n}\cdot \hat{\lambda}$|
</div>
donde $n=k_1+\cdots +k_N$. 

## Test $\chi^2$
El test $\chi^2$ consiste en hallar el siguiente **estadístico de contraste**
$$
\chi^2 = \sum_{i=1}^N \frac{(k_i-\frac{n_i}{n}\cdot \hat{\lambda})^2}{\frac{n_i}{n}\cdot \hat{\lambda}},
$$
que si la **hipótesis nula** es cierta donde recordemos que nuestra **hipótesis nula** era que el **coronavirus** se infectaba aleatoriamente por igual en todos los países, se distribuye según una variable $\chi^2_{N-1}$

## Test $\chi^2$
El **p-valor** del contraste anterior será:
$$
p = p(\chi^2_{N-1}>\chi^2).
$$
Si el $p$ anterior es muy pequeño, concluiremos que tenemos evidencias suficientes para **rechazar** la hipótesis nula y decir que el virus no se **expande** de la misma manera por todos los países.


# Resolución en `R`

## Tabla de datos
Para realizar el estudio anterior, usaremos la tabla de datos `covid19`.

Vamos a cargarla:
```{r}
covid19=read.csv("covid_19_clean_complete.csv")
```

## Tabla de datos

Hagamos un pequeño resumen de las variables de dicha tabla de datos:
```{r}
str(covid19)
```

## Tabla de datos
Como vemos, es una tabla de datos con 8 variables:

* `Province.State`: nos indica la provincia o el estado del país en cuestión.
* `Country.Region`: nos dice el país donde están los datos.
* `Lat`: nos da la latitud del pais.
* `Long`: nos da la longitud del pais.
* `Date`: nos dice la fecha en la que han sido tomados los datos.
* `Confirmed`: nos da el número de infectados en una determinada región de un país determinado en una fecha determinada.
* `Death`: lo mismo que la variable anterior pero nos da el número de víctimas.
* `Recovered`: lo mismo que la variable anterior pero nos da el número de recuperados. 


## Número de habitantes por países

Para calcular el número de habitantes por países vamos a usar la función `wb` del paquete `wbstats`:
```{r}
library(wbstats)
pop_data <- wb(indicator = "SP.POP.TOTL", startdate = 2018, enddate = 2019)
```
Como podemos ver, hemos cargado el paquete y, a partir de la función anterior le hemos dicho que nos dé el número de habitantes por países desde 2018 hasta 2019 (aún no se dispone de datos del año actual 2020)

## Número de habitantes por países
Veamos a modo de ejemplo el número de habitantes de España, Italia y Francia:
```{r}
pop_data[pop_data$country=="Spain",]
pop_data[pop_data$country=="Italy",]
pop_data[pop_data$country=="France",]
```

## Limpieza de la tabla de datos
El siguiente paso es "limpiar" la tabla de datos `cov19` eliminando todos aquellos paises de los que no tenemos datos:
```{r}
paises=unique(covid19$Country.Region)
covid19.limpio =c()
for (i in 1:length(paises)){
  if(length(which(paises[i] %in% pop_data$country))>0){
    covid19.limpio = rbind(covid19.limpio,covid19[covid19$Country.Region==paises[i],])
  }
}

```

## Limpieza de la tabla de datos

Como podemos observar en el vector `paises` hemos colocado todos los paises de la tabla de datos `cov19` y para cada país, comprobamos si sus datos están en la tabla de datos `pop_data` y si están, lo añadimos a la nueva tabla de datos `covid19.limpio`.

En total, teníamos al principio en la tabla de datos original `covid19` `r dim(covid19)[1]` paises de los que han "sobrevivido" `r dim(covid19.limpio)[1]` países.

## Cálculo de las frecuencias reales $k_i$ para cada país
A continuación, fijamos una fecha para realizar nuestro estudio:
```{r}
fecha="3/15/20"
```
Fijémonos que primero está el mes, luego el día y, para finalizar, el año. Por tanto, nuestro estudio es para el día 15 de marzo del año actual 2020.

El número de casos confirmados por país se calcula con la función `aggregate`:
```{r}
confirmados.por.pais = aggregate(covid19.limpio$Confirmed[covid19.limpio$Date==fecha] ~ 
                    covid19.limpio$Country.Region[covid19.limpio$Date==fecha],FUN=sum)
names(confirmados.por.pais)=c("Pais","Confirmados")
```

## Cálculo de las frecuencias reales $k_i$ para cada país
Los confirmados de los 10 primeros países serán:
```{r}
head(confirmados.por.pais,10)
```

## Estimación del valor de $\lambda$
Recordemos que para estimar $\lambda$, hemos de usar la fórmula siguiente: $\hat{\lambda}=$Número total de infectados:
```{r}
paises=unique(covid19.limpio$Country.Region)
suma.total.habitantes=sum(pop_data[pop_data$country %in% paises,]$value)
estimación.lambda = sum(covid19.limpio[covid19.limpio$Date==fecha,]$Confirmed)
```

## Estimación del valor de $\lambda$

Como podemos observar, volvemos a calcular los países con la tabla de datos limpia `covid19.limpio`, a continuación calculamos el número total de habitantes del estudio sumando la variable `value` de la tabla de datos `pop_data` para los paises en cuestión. Por último, calculamos la estimación de lambda sumando los valores de la variable `Confirmed` de la tabla de datos `covid19.limpio`.

## Cálculo de las frecuencias esperadas $\frac{n_i}{n}\cdot \hat{\lambda}$ para cada pais
Recordemos que el número de infectados esperado para el pais $P_i$ era: $\frac{n_i}{n}\cdot \hat{\lambda}$, donde $n_i$, el número de habitantes de cada pais, ya lo tenemos en la tabla de datos `pop_data`, $n$, el número de habitantes total, ya lo hemos calculado antes en la variable `suma.total.habitantes` y $\hat{\lambda}$ ya está estimado en la variable `estimación.lambda`.


## Cálculo de las frecuencias esperadas $\frac{n_i}{n}\cdot \hat{\lambda}$ para cada pais
Para calcular las frecuencias esperadas $\frac{n_i}{n}\cdot \hat{\lambda}$ para cada pais, vamos a crear una tabla llamada `tabla.infectados.paises` que tendrá tres columnas:

* `pais`: donde habrá el nombre del país en cuestión.
* `infectados`: donde habrá los infectados reales $k_i$ de cada país.
* `estimados`: donde habrá los infectados estimados $\frac{n_i}{n}\cdot \hat{\lambda}$ de cada país.

## Cálculo de las frecuencias esperadas $\frac{n_i}{n}\cdot \hat{\lambda}$ para cada pais
```{r}
tabla.infectados.paises =c()

for (i in 1:length(paises)){
    habitantes=pop_data[pop_data$country==paises[i],]$value
    confirmados = confirmados.por.pais$Confirmados[confirmados.por.pais$Pais==paises[i]]
    confirmados.estimados = estimación.lambda*habitantes/suma.total.habitantes
    tabla.infectados.paises=rbind(tabla.infectados.paises,
                                  c(confirmados,confirmados.estimados))
}
tabla.infectados.paises=as.data.frame(tabla.infectados.paises)
tabla.infectados.paises = data.frame(paises,tabla.infectados.paises)
names(tabla.infectados.paises)=c("pais","infectados","infectados.estimados")
```

## Test $\chi^2$

A continuación realizamos el test de la $\chi^2$:
```{r}
chisq.test(tabla.infectados.paises$infectados,
  p=tabla.infectados.paises$infectados.estimados/sum(tabla.infectados.paises$infectados))
```

## Test $\chi^2$
¡Ups! Tenemos problemas, parece que hay países donde sus frecuencias esperadas de infectados no llegan a 5. Veamos qué paises son:
```{r}
paises.con.problemas = which(tabla.infectados.paises$infectados.estimados < 5)
paises[paises.con.problemas]
```


## Test $\chi^2$
Vamos a juntarlos en un sólo país y volver a aplicar el test de la $\chi^2$. Primero los quitamos:
```{r}
tabla.infectados.paises2 = tabla.infectados.paises[-paises.con.problemas,]
```

A continuación sumamos el número total de infectados y de infectados esperados para estos países:
```{r}
pais.añadir = data.frame("problemas",sum(tabla.infectados.paises[
  tabla.infectados.paises$pais%in% paises[paises.con.problemas],]
  $infectados),sum(tabla.infectados.paises[tabla.infectados.paises$
  pais %in% paises[paises.con.problemas],]$infectados.estimados))
names(pais.añadir)=names(tabla.infectados.paises2)
pais.añadir
```

## Test $\chi^2$
Comprobamos que la frecuencia esperada de infectados de la suma de todos ya supera 5.

Añadimos el "nuevo pais" y volvemos a realizar el test de la $\chi^2$:
```{r}
tabla.infectados.paises2 = rbind(tabla.infectados.paises2,pais.añadir)

chisq.test(tabla.infectados.paises2$infectados,
  p=tabla.infectados.paises2$infectados.estimados/sum(tabla.infectados.paises2$infectados))

```

## Conclusión

Vemos que el p-valor es muy pequeño por lo que concluimos que el virus no se expandió por igual en todos los países el día 15 de marzo tal como era de esperar.

## Estudio el día 30 de marzo
Realizemos todo el estudio anterior pero ahora cambiando de fecha. Veamos si el virus se expandió por igual en todos los países el día 30 de marzo:
```{r}
fecha="3/30/20"
confirmados.por.pais = aggregate(covid19.limpio$Confirmed[covid19.limpio$Date==fecha] ~ 
                    covid19.limpio$Country.Region[covid19.limpio$Date==fecha],FUN=sum)
names(confirmados.por.pais)=c("Pais","Confirmados")
estimación.lambda = sum(covid19.limpio[covid19.limpio$Date==fecha,]$Confirmed)
```

## Estudio el día 30 de marzo
```{r}
tabla.infectados.paises =c()

for (i in 1:length(paises)){
    habitantes=pop_data[pop_data$country==paises[i],]$value
    confirmados = confirmados.por.pais$Confirmados[confirmados.por.pais$Pais==paises[i]]
    confirmados.estimados = estimación.lambda*habitantes/suma.total.habitantes
    tabla.infectados.paises=rbind(tabla.infectados.paises,
                                  c(confirmados,confirmados.estimados))
}
tabla.infectados.paises=as.data.frame(tabla.infectados.paises)
tabla.infectados.paises = data.frame(paises,tabla.infectados.paises)
names(tabla.infectados.paises)=c("pais","infectados","infectados.estimados")


```

## Estudio el día 30 de marzo
```{r}
paises.con.problemas = which(tabla.infectados.paises$infectados.estimados < 5)
tabla.infectados.paises2 = tabla.infectados.paises[-paises.con.problemas,]
pais.añadir = data.frame("problemas",sum(tabla.infectados.paises[
  tabla.infectados.paises$pais%in% paises[paises.con.problemas],]
  $infectados),sum(tabla.infectados.paises[tabla.infectados.paises$
  pais %in% paises[paises.con.problemas],]$infectados.estimados))
names(pais.añadir)=names(tabla.infectados.paises2)
tabla.infectados.paises2 = rbind(tabla.infectados.paises2,pais.añadir)

chisq.test(tabla.infectados.paises2$infectados,
  p=tabla.infectados.paises2$infectados.estimados/sum(tabla.infectados.paises2$infectados))

```

## Conclusiones
La conclusión es la misma que para la fecha del 15 de marzo: concluimos que tenemos indicios suficientes para afirmar que el virus no se expandió de la misma manera en todos los países.
